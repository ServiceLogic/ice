<% if(!hasJsxRuntime) { %>
  import * as React from 'react';
<% } %>
import { FC, createContext, useContext, useState } from 'react';
import { history } from 'create-app-shared';
import Cookies from 'universal-cookie';

const LOCALE_COOKIE_KEY = '<%= LOCALE_COOKIE_KEY %>';

const Context = createContext<any>(null);

interface Props {
  value: string;
}

const LocaleProvider: FC<Props> = ({ value: defaultLocale, children }) => {
  const [, setActiveLocale] = useState<string>(defaultLocale);
  const locale = getLocale();

  function setLocale(locale: string) {
    setLocaleToCookies(locale);
    redirect(locale);
    setActiveLocale(locale);
  }
  return (
    <Context.Provider value={[locale, setLocale]}>
      {children}
    </Context.Provider>
  )
}

function useLocale(): [string, React.Dispatch<React.SetStateAction<string>>] {
  return useContext(Context)
}

function getDefaultLocale(): string {
  return '<%= defaultLocale %>'
}

function getAllLocales(): string[] {
  return <%- JSON.stringify(locales) %>
}

/**
 * get current locale from url(location.pathname)
 */
function getLocale(): string {
  const { location: { pathname } } = history;
  const subRoutes = pathname.split('/').filter((item: string) => item);
  const prefixRoute = subRoutes[0];
  const locales = <%- JSON.stringify(locales) %> || [];
  if (locales.includes(prefixRoute)) {
    return prefixRoute;
  }

  return '<%= defaultLocale %>';
}

function setLocaleToCookies(locale: string) {
  const cookies = new Cookies();
  cookies.set(LOCALE_COOKIE_KEY, locale, { path: '/' });
}

function redirect(locale: string) {
  if (!history) {
    console.error('history is null');
  }

  const { location: { pathname } } = history;
  let subRoutes = pathname.split('/').filter((item: string) => item);

  if (locale === '<%= defaultLocale %>') {
    subRoutes = subRoutes.slice(1);
  } else {
    subRoutes[0] = locale;
  }

  const newPathname = subRoutes.join('/');
  history.push(newPathname);
}

export { 
  useLocale, 
  LocaleProvider,
  getDefaultLocale,
  getAllLocales,
  getLocale,
  setLocaleToCookies,
};